# define the source files
SRCDIR = .\src
BUILDDIR = .\bin

#cmake
FABM_SOURCE=$(SRCDIR)\fabm
FABM_BUILD_DIR=$(BUILDDIR)\fabm-build
FABM_LIB_DIR=$(BUILDDIR)\fabm-lib

FABM_INCLUDES = -I$(FABM_LIB_DIR)\include
FABM_LFLAGS = -L$(FABM_LIB_DIR)\lib\libfabm.a
FABM_LIBS = $(FABM_LIB_DIR)\lib\libfabm.a

#cmake options
CMAKE_CACHE_ENTRY=-DCMAKE_BUILD_TYPE=Release -DCMAKE_GNUtoMS=0 -DCMAKE_INSTALL_PREFIX=..\..\$(FABM_LIB_DIR) -DFABM_HOST=simstrat

# Fortran compiler
CC = x86_64-w64-mingw32-gfortran

# compile-time flags
#CFLAGS = -O3 -march=corei7
CFLAGS = -march=corei7 -Ofast

SIMSTRAT_SRC = $(SRCDIR)\simstrat
SIMSTRAT_BUILD = $(BUILDDIR)\simstrat


SIMSTRAT_MODULES := simstrat_type.f90 \
					SimstratModel.f90 \
					utilities.f90 \
					SimstratOutput.f90 \
					Advection.f90 \
					SimstratModelInitializer.f90 \
					Coriolis.f90 \
					Transport.f90 \
					UVEquation.f90 \
					Temperature.f90 \
					Stability.f90 \
					Turbulence.f90 \
					Forcing.f90 \
					Absorption.f90
SIMSTRAT_FABM_MODULES := simstrat_fabm.f90
SIMSTRAT_EXEC := simstrat.f90

simstrat_only: $(SIMSTRAT_BUILD) compile_simstrat_modules
	$(CC) $(CFLAGS) -cpp -c $(SIMSTRAT_SRC)\$(SIMSTRAT_EXEC) -o $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.o) -I$(SIMSTRAT_BUILD)
	$(CC) -o $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.exe) $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.o) $(addprefix $(SIMSTRAT_BUILD)\,$(SIMSTRAT_MODULES:.f90=.o))
	@echo  Successfuly compiled simstrat

simstrat_fabm: DFLAG += -Duse_fabm
simstrat_fabm: fabm_build fabm_lib $(SIMSTRAT_BUILD) compile_simstrat_modules compile_simstrat_fabm_modules
	$(CC) $(CFLAGS) $(FABM_INCLUDES) -Duse_fabm -cpp -c $(SIMSTRAT_SRC)\$(SIMSTRAT_EXEC) -o $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.o) -I$(SIMSTRAT_BUILD)
	$(CC) -o $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.exe) $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.o) $(addprefix $(SIMSTRAT_BUILD)\,$(SIMSTRAT_MODULES:.f90=.o)) $(addprefix $(SIMSTRAT_BUILD)\,$(SIMSTRAT_FABM_MODULES:.f90=.o)) $(FABM_LIBS)
	@echo  Successfuly compiled simstrat_fabm

recompile_simstrat_fabm: DFLAG += -Duse_fabm
recompile_simstrat_fabm: $(SIMSTRAT_BUILD) compile_simstrat_modules compile_simstrat_fabm_modules
	$(CC) $(CFLAGS) $(FABM_INCLUDES) -Duse_fabm -cpp -c $(SIMSTRAT_SRC)\$(SIMSTRAT_EXEC) -o $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.o) -I$(SIMSTRAT_BUILD)
	$(CC) -o $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.exe) $(SIMSTRAT_BUILD)\$(SIMSTRAT_EXEC:.f90=.o) $(addprefix $(SIMSTRAT_BUILD)\,$(SIMSTRAT_MODULES:.f90=.o)) $(addprefix $(SIMSTRAT_BUILD)\,$(SIMSTRAT_FABM_MODULES:.f90=.o)) $(FABM_LIBS)
	@echo  Successfuly compiled simstrat_fabm

fabm_build:
	@echo  create FABM build
	@mkdir $(FABM_BUILD_DIR)
	@cd $(FABM_BUILD_DIR) && cmake $(CMAKE_CACHE_ENTRY) -G"MinGW Makefiles" ..\..\$(FABM_SOURCE)

fabm_lib:
	@echo  create FABM lib
	@mkdir $(FABM_LIB_DIR)
	@cd $(FABM_BUILD_DIR) && mingw32-make install

$(SIMSTRAT_BUILD):
	@mkdir $(SIMSTRAT_BUILD)

%.o: $(SIMSTRAT_SRC)\%.f90
	$(CC) $(CFLAGS) $(FABM_INCLUDES) $(DFLAG) -cpp -c $^ -o $(SIMSTRAT_BUILD)\$@ -J$(SIMSTRAT_BUILD)

compile_simstrat_modules: $(SIMSTRAT_MODULES:.f90=.o)
compile_simstrat_fabm_modules: $(SIMSTRAT_FABM_MODULES:.f90=.o)
	
clean_simstrat:
	@rmdir /S /Q $(SIMSTRAT_BUILD)

clean:
	@rmdir /S /Q $(BUILDDIR)